<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ê–¥–º–∏–Ω ‚Äî Clients + –ø–∞–ø–∫–∏ (fishbibon)</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --muted:#9fb0d0;
      --text:#e9efff;
      --accent:#6aa3ff;
      --danger:#ff4d5e;
      --ok:#39d98a;
      --line:rgba(255,255,255,.08);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(1200px 600px at 20% 0%, rgba(106,163,255,.18), transparent 50%),
                 radial-gradient(1000px 700px at 80% 10%, rgba(57,217,138,.14), transparent 45%),
                 var(--bg);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans",sans-serif;
    }
    a{color:inherit}

    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 16px;background:rgba(17,26,51,.75);
      border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);backdrop-filter:blur(10px);
      position:sticky;top:12px;z-index:5;
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand .t{font-weight:800;letter-spacing:.2px}
    .brand .s{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      font-weight:700;cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.primary{background:rgba(106,163,255,.16);border-color:rgba(106,163,255,.35)}
    .btn.danger{background:rgba(255,77,94,.14);border-color:rgba(255,77,94,.35)}
    .btn.ghost{background:transparent}

    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      font-size:12px;color:var(--muted);background:rgba(255,255,255,.04);
      max-width:55vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .card{
      background:rgba(17,26,51,.75);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }

    .layout{display:grid;gap:14px;margin-top:14px}
    @media (min-width: 1020px){
      .layout{grid-template-columns: 300px 1fr 360px; align-items:start;}
    }

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input, select{
      width:100%;
      padding:12px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);outline:none;
    }
    input::placeholder{color:rgba(233,239,255,.45)}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .dangerText{color:var(--danger)}
    .ok{color:var(--ok)}

    /* KPI */
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);min-width:120px;
    }
    .kpi .box .n{font-weight:900;font-size:18px}
    .kpi .box .l{font-size:12px;color:var(--muted)}

    /* Tables/cards */
    .tableWrap{display:none}
    @media (min-width: 1020px){.tableWrap{display:block}.cardsWrap{display:none}}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:14px}
    th, td{padding:12px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted);font-weight:800;background:rgba(255,255,255,.04)}
    td{font-size:13px}
    .badge{
      font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:var(--muted);max-width:42vw;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .linkBtn{
      text-decoration:none;border:1px solid var(--line);background:rgba(255,255,255,.06);
      padding:10px 12px;border-radius:14px;font-weight:800;font-size:13px;
      display:inline-flex;align-items:center;gap:8px;
    }
    .linkBtn:hover{background:rgba(255,255,255,.10)}

    .clientCard{
      display:flex;flex-direction:column;gap:10px;padding:14px;border-radius:var(--radius);
      border:1px solid var(--line);background:rgba(255,255,255,.04);
    }
    .clientHead{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .clientTitle{display:flex;flex-direction:column;gap:2px}
    .clientTitle .main{font-weight:900}
    .clientTitle .sub{font-size:12px;color:var(--muted)}
    .miniRow{display:flex;gap:10px;flex-wrap:wrap}
    .mini{
      font-size:12px;color:var(--muted);border:1px dashed rgba(255,255,255,.14);
      padding:8px 10px;border-radius:14px;
    }
    .mini b{color:var(--text)}
    .links{display:flex;gap:10px;flex-wrap:wrap}

    /* Selection */
    .chk{width:18px;height:18px;accent-color: var(--accent); cursor:pointer;}
    .bulkBar{
      display:none;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);margin-top:10px;
    }
    .bulkLeft{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pillSmall{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:var(--muted);font-size:12px;
    }

    /* Folders sidebar */
    .folderHeader{display:flex;gap:10px;margin-bottom:8px}
    .folderTitle{font-weight:900;font-size:16px}
      .folder-list {
          display: flex;
          flex-direction: column;
          gap: 6px;
          margin: 10px 0 20px
      }
    .folder-item{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:8px 10px;border-radius:14px;background:rgba(255,255,255,.04);
      border:1px solid transparent;cursor:pointer;transition:.1s;
      user-select:none;
    }
    .folder-item:hover{background:rgba(255,255,255,.08)}
    .folder-item.selected{border-color:var(--accent);background:rgba(106,163,255,.12)}
    .folder-left{display:flex;align-items:center;gap:8px;min-width:0}
    .folder-name{font-weight:650;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width: 180px;}
    .folder-count{
      font-size:12px;color:var(--muted);background:rgba(0,0,0,.3);
      padding:2px 10px;border-radius:30px;flex:0 0 auto;
    }
    .folder-actions{display:flex;align-items:center;gap:6px;flex:0 0 auto}
    .iconBtn{
      border:1px solid var(--line);background:rgba(255,255,255,.04);
      color:var(--text);border-radius:12px;padding:6px 8px;cursor:pointer;font-weight:800;
    }
    .iconBtn:hover{background:rgba(255,255,255,.08)}
    .dragOver{outline: 2px solid rgba(106,163,255,.6); outline-offset: 2px;}

    /* Filters panel */
    .panelHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer}
    .panelHeader .t{font-weight:900;font-size:16px}
    .panelBody{margin-top:12px}
    .collapsed .panelBody{display:none}

    .acc{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.03);margin-top:10px}
    .accBtn{
      width:100%;display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;background:rgba(255,255,255,.04);
      border:0;color:var(--text);cursor:pointer;font-weight:850;
    }
    .accBtn:hover{background:rgba(255,255,255,.07)}
    .accBody{padding:12px;display:none}
    .acc.open .accBody{display:block}
    .accMeta{font-size:12px;color:var(--muted);font-weight:700}

    .filterFooter{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .filterFooter .btn{flex:1}

    /* Modals */
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:18px;z-index:50;
    }
    .modal{
      width:min(920px,100%);max-height:86vh;overflow:auto;
      background:rgba(17,26,51,.92);border:1px solid var(--line);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;backdrop-filter:blur(14px);
    }
    .modalTop{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .modalTop .title{font-weight:900}
    .kv{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    @media (min-width: 720px){.kv{grid-template-columns:1fr 1fr}}
    .kv .item{border:1px solid var(--line);background:rgba(255,255,255,.04);border-radius:14px;padding:10px}
    .kv .item .k{font-size:12px;color:var(--muted);margin-bottom:6px}
    .kv .item .v{font-size:13px;word-break:break-word}
    .kv .item .vClamp{display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}

    /* Empty state */
    .emptyState{
      display:none;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      padding:14px;
      background:rgba(255,255,255,.03);
      margin-top:12px;
    }
    .emptyState .h{font-weight:900;margin-bottom:6px}
    .emptyState .p{color:var(--muted);font-size:12px;line-height:1.45}
    .muted{color:var(--muted)}
  
/* ---------- Mobile-first additions (320‚Äì430) + tablet (>=768) ---------- */
:focus-visible{outline:2px solid rgba(106,163,255,.75); outline-offset:2px}
@media (prefers-reduced-motion: reduce){
  *{scroll-behavior:auto !important; transition:none !important; animation:none !important}
}

/* a11y helper */
.srOnly{
  position:absolute !important;
  width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;
  clip:rect(0,0,0,0);white-space:nowrap;border:0;
}

/* Chips / swipe carousel */
.chips{
  display:flex; gap:8px;
  overflow-x:auto; overflow-y:hidden;
  padding:2px 2px 10px;
  -webkit-overflow-scrolling:touch;
  scroll-snap-type:x mandatory;
  scrollbar-width:none;
}
.chips::-webkit-scrollbar{display:none}
.chip{
  scroll-snap-align:start;
  display:inline-flex; align-items:center; gap:8px;
  padding:0 12px;
  height:44px; /* >=44px tap target */
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  color:var(--text);
  font-weight:800;
  cursor:pointer;
  flex:0 0 auto;
}
.chip:hover{background:rgba(255,255,255,.08)}
.chip.selected{border-color:rgba(106,163,255,.55); background:rgba(106,163,255,.14)}
.chip .chipCount{
  font-size:12px;
  color:var(--muted);
  border:1px solid rgba(255,255,255,.10);
  padding:2px 8px;
  border-radius:999px;
  background:rgba(0,0,0,.25);
}

/* Bottom navigation */
.bottomNav{
  position:fixed; left:0; right:0; bottom:0;
  z-index:40;
  display:none;
  padding:10px 10px calc(10px + env(
        <!-- Mobile quick controls (–ø–æ–∏—Å–∫/–ø–∞–ø–∫–∏/–ø–µ—Ä–∏–æ–¥) -->
        <div class="mobileQuick" id="mobileQuick">
          <div class="quickRow">
            <div class="field" style="flex:1">
              <label class="srOnly" for="qMobile">–ü–æ–∏—Å–∫</label>
              <input id="qMobile" type="text" placeholder="–ü–æ–∏—Å–∫‚Ä¶ (Android, UID, iPhone‚Ä¶)" />
            </div>
            <button id="openFiltersBtn" class="iconBtn iconBtnLg" type="button" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M3 5h18M6 12h12M10 19h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>

          <div id="folderChips" class="chips" aria-label="–ü–∞–ø–∫–∏ (—Å–≤–∞–π–ø)"></div>

          <div id="rangeChips" class="chips" aria-label="–ü–µ—Ä–∏–æ–¥">
            <button class="chip" type="button" data-range="all">–í—Å–µ</button>
            <button class="chip" type="button" data-range="24h">24—á</button>
            <button class="chip" type="button" data-range="7d">7–¥</button>
            <button class="chip" type="button" data-range="30d">30–¥</button>
          </div>
        </div>
safe-area-inset-bottom));
  background:rgba(17,26,51,.86);
  border-top:1px solid var(--line);
  backdrop-filter:blur(12px);
}
.bottomNav .navRow{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:8px;
}
.navBtn{
  height:52px;
  border-radius:16px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  color:var(--text);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:4px;
  cursor:pointer;
}
.navBtn svg{width:20px;height:20px}
.navBtn .l{font-size:11px; color:var(--muted); font-weight:750}
.navBtn.active{border-color:rgba(106,163,255,.55); background:rgba(106,163,255,.14)}
.navBtn:active{transform:translateY(1px)}

/* Drawer / bottom sheet */
.drawerBack{
  position:fixed; inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:flex-end;
  z-index:60;
}
.drawer{
  width:100%;
  max-height:92vh;
  background:rgba(17,26,51,.92);
  border:1px solid var(--line);
  border-bottom:0;
  border-radius:18px 18px 0 0;
  box-shadow:var(--shadow);
  padding:12px 12px calc(14px + env(safe-area-inset-bottom));
  overflow:auto;
  backdrop-filter:blur(14px);
}
.drawerTop{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:6px 4px 10px;
  position:sticky; top:0;
  background:linear-gradient(to bottom, rgba(17,26,51,.96), rgba(17,26,51,.70));
  backdrop-filter:blur(10px);
  z-index:1;
}
.drawerTitle{font-weight:900}
.iconBtnLg{
  height:44px; width:44px; border-radius:14px;
  display:inline-flex; align-items:center; justify-content:center;
}
.iconBtnLg svg{width:20px;height:20px}

/* Make panels look native when mounted into drawer */
.inDrawer{
  background:transparent !important;
  border:0 !important;
  box-shadow:none !important;
  padding:0 !important;
}

/* Mobile quick controls above list */
.mobileQuick{display:none}
.quickRow{display:flex; gap:10px; align-items:end}
.quickRow .field label{display:none}
.quickRow input{min-height:44px}
.quickRow .iconBtnLg{flex:0 0 auto}

/* Tablet layout (>=768): 2 columns + stacked side panels */
@media (min-width: 768px) and (max-width: 1019px){
  .layout{
    grid-template-columns: 320px 1fr;
    grid-template-areas:
      "folders list"
      "right   list";
    align-items:start;
  }
  #foldersPanel{grid-area:folders; display:block}
  #listPanel{grid-area:list}
  #rightPanel{grid-area:right}
}

/* Mobile (<=767): single column + bottom nav + drawers */
@media (max-width: 767px){
  .wrap{padding:12px}
  .topbar{top:8px;border-radius:16px;padding:12px}
  .brand .t{font-size:14px; line-height:1.15}
  .brand .s{display:none} /* –¥–ª–∏–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∫–æ–Ω—Ñ–∏–≥–æ–≤ —É—Ö–æ–¥–∏—Ç –≤ ‚Äú–ï—â—ë‚Äù */
  .actions{gap:8px}
  .btn, .linkBtn, input, select{min-height:44px}
  .btn{padding:10px 12px}
  .pill{max-width:60vw}

  /* –Ω–∞ –º–æ–±–∏–ª–µ —Ä–∞–±–æ—Ç–∞–µ–º ‚Äú–ö–ª–∏–µ–Ω—Ç—ã first‚Äù, —Ñ–∏–ª—å—Ç—Ä—ã/–ø–∞–ø–∫–∏ ‚Äî –≤ —à—Ç–æ—Ä–∫–∞—Ö */
  #foldersPanel{display:none}
  body.authed #rightPanel{display:none}

  .mobileQuick{display:block; margin-top:10px}
  .links{display:grid; grid-template-columns:1fr; gap:10px}
  .linkBtn{justify-content:center}
  .clientHead{gap:12px}
  .clientTitle .main{font-size:15px}

  /* Bulk actions ‚Äî –ª–∏–ø–∫–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–¥ –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π */
  .bulkBar{
    position:sticky;
    bottom: calc(84px + env(safe-area-inset-bottom));
    z-index:4;
  }

  /* Modals as bottom sheets */
  .modalBack{align-items:flex-end; justify-content:stretch; padding:0}
  .modal{
    width:100%;
    max-height:92vh;
    border-radius:18px 18px 0 0;
    border-bottom:0;
  }

  .bottomNav{display:block}
  body:not(.authed) .bottomNav{display:none}
}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="t">Clients Fishing</div>
        <div class="s">Firestore: <span class="mono">(default)</span> ‚Ä¢ Collections: <span class="mono">Clients</span> + <span class="mono">Folders</span></div>
      </div>
      <div class="actions">
        <div id="userPill" class="pill" style="display:none"></div>
        <button id="btnSignOut" class="btn" style="display:none">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div class="layout">
      <!-- Left: folders -->
      <div id="foldersPanel" class="card" style="display:none">
        <div class="folderHeader">
          <div class="folderTitle">–ü–∞–ø–∫–∏</div>
          <button id="createFolderBtn" class="btn" style="padding:8px 12px

  <nav class="bottomNav" id="bottomNav" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
    <div class="navRow">
  
     
      <button class="navBtn" id="navFilters" type="button" aria-label="–§–∏–ª—å—Ç—Ä—ã">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 5h18l-7 8v5l-4 2v-7L3 5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
        <div class="l">–§–∏–ª—å—Ç—Ä—ã</div>
      </button>
     
    </div>
  </nav>

  <div id="drawerBack" class="drawerBack" aria-hidden="true">
    <div class="drawer" role="dialog" aria-modal="true" aria-label="–ü–∞–Ω–µ–ª—å">
      <div class="drawerTop">
        <div class="drawerTitle" id="drawerTitle">‚Äî</div>
        <button id="drawerClose" class="iconBtn iconBtnLg" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div id="drawerBody"></div>
    </div>
  </div>–°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <div id="folderList" class="folder-list"></div>
        <div id="foldersEmpty" class="hint" style="display:none">–ü–∞–ø–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é (–º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ).</div>
      </div>

      <!-- Center: list -->
      <div id="listPanel" class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap">
          <div style="font-weight:900; font-size:16px;">–ö–ª–∏–µ–Ω—Ç—ã</div>
          <div class="hint" id="statusLine">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ö–æ–¥–∞‚Ä¶</div>
        </div>

        <div id="bulkBar" class="bulkBar">
          <div class="bulkLeft">
            <span class="pillSmall" id="selPill">–í—ã–±—Ä–∞–Ω–æ: 0</span>
            <button id="bulkMoveBtn" class="btn primary">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å‚Ä¶</button>
            <button id="bulkClearBtn" class="btn">–°–Ω—è—Ç—å</button>
          </div>
          <div class="muted" style="font-size:12px">Drag & drop —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</div>
        </div>

        <div style="height:12px"></div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:44px"></th>
                <th>–í—Ä–µ–º—è</th>
                <th>–ö–ª–∏–µ–Ω—Ç</th>
                <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
                <th>–ì–µ–æ</th>
                <th>–ü–∞–ø–∫–∞</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

        <div class="cardsWrap" id="cardsWrap"></div>

        <div id="empty" class="emptyState">
          <div class="h" id="emptyTitle">–ü—É—Å—Ç–æ</div>
          <div class="p" id="emptyText">‚Äî</div>
          <div class="filterFooter" style="margin-top:10px">
            <button id="emptyResetBtn" class="btn">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
          </div>
        </div>
      </div>

      <!-- Right: auth + filters -->
      <div id="rightPanel" class="card">
        <div id="authBox">
          <div style="font-weight:900; font-size:16px;">–í—Ö–æ–¥</div>
          <div class="hint">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Firebase Authentication (Email/Password).</div>
          <div style="height:10px"></div>
          <div class="field">
            <label>Email</label>
            <input id="email" type="email" placeholder="you@example.com" autocomplete="username" />
          </div>
          <div style="height:10px"></div>
          <div class="field">
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
          </div>
          <div style="height:12px"></div>
          <div class="row">
            <button id="btnSignIn" class="btn primary" style="flex:1">–í–æ–π—Ç–∏</button>
          </div>
          <div id="authMsg" class="hint"></div>
        </div>

        <div id="filtersBox" style="display:none">
          <div id="filtersHeader" class="panelHeader">
            <div class="t">–§–∏–ª—å—Ç—Ä—ã</div>
            <div class="accMeta"><span id="filtersHeaderMeta">‚Äî</span> <span id="filtersChevron">üîº</span></div>
          </div>

          <div id="filtersBody" class="panelBody">
            <div class="acc" data-acc="search">
              <button class="accBtn" type="button">
                <span>–ü–æ–∏—Å–∫</span><span class="accMeta" id="accMetaSearch">‚Äî</span>
              </button>
              <div class="accBody">
                <div class="field">
                  <label>–°—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–∞</label>
                  <input id="q" type="text" placeholder="Android, ru, UID, 77.6, iPhone‚Ä¶" />
                </div>
              </div>
            </div>

            <div class="acc" data-acc="period">
              <button class="accBtn" type="button">
                <span>–ü–µ—Ä–∏–æ–¥</span><span class="accMeta" id="accMetaPeriod">‚Äî</span>
              </button>
              <div class="accBody">
                <div class="field">
                  <label>–ü–µ—Ä–∏–æ–¥</label>
                  <select id="range">
                    <option value="all">–í—Å–µ</option>
                    <option value="24h">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞</option>
                    <option value="7d">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                    <option value="30d">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="acc" data-acc="sort">
              <button class="accBtn" type="button">
                <span>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</span><span class="accMeta" id="accMetaSort">‚Äî</span>
              </button>
              <div class="accBody">
                <div class="row" style="align-items:end">
                  <div class="field" style="flex:1; min-width: 220px">
                    <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</label>
                    <select id="sortField">
                      <option value="date">‚è±Ô∏è –¥–∞—Ç–∞</option>
                      <option value="name">üìõ –Ω–∞–∑–≤–∞–Ω–∏–µ</option>
                      <option value="folder">üìÅ –ø–∞–ø–∫–∞</option>
                    </select>
                  </div>
                  <div class="field" style="min-width: 130px">
                    <label>–ü–æ—Ä—è–¥–æ–∫</label>
                    <button id="sortDirBtn" class="btn" type="button">‚¨áÔ∏è —É–±—ã–≤.</button>
                  </div>
                </div>
                <div class="hint" style="margin-top:10px">–í—ã–±–æ—Ä —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è.</div>
              </div>
            </div>

            <div class="filterFooter">
              <button id="btnReset" class="btn" type="button">–°–±—Ä–æ—Å–∏—Ç—å</button>
              <button id="btnApply" class="btn primary" type="button">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>

            <div style="height:12px"></div>
            <div class="kpi">
              <div class="box">
                <div class="n" id="kpiTotal">‚Äî</div>
                <div class="l">–ó–∞–ø–∏—Å–µ–π</div>
              </div>
              <div class="box">
                <div class="n" id="kpiGeo">‚Äî</div>
                <div class="l">–° –≥–µ–æ</div>
              </div>
            </div>

            <div class="hint">üü¢ –†–µ–∞–ª—Ç–∞–π–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: client details -->
  <div id="modalBack" class="modalBack">
    <div class="modal">
      <div class="modalTop">
        <div>
          <div class="title" id="modalTitle">–î–µ—Ç–∞–ª–∏</div>
          <div class="hint" id="modalSub"></div>
        </div>
        <div class="row">
          <a id="modal2gis" class="btn primary" style="text-decoration:none; display:none" target="_blank" rel="noopener">2GIS</a>
          <button id="modalDelete" class="btn danger">–£–¥–∞–ª–∏—Ç—å</button>
          <button id="modalClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="card" style="background: rgba(255,255,255,.04); border-radius: 14px; padding:12px;">
        <div class="row" style="align-items:end">
          <div class="field" style="min-width:240px; flex:1">
            <label>–ö–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ (clientName)</label>
            <input id="nameInput" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–ª–∏–µ–Ω—Ç 12 / K-123ABC" />
          </div>
          <button id="nameSave" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="copyId" class="btn">Copy ID</button>
        </div>
      </div>

      <div class="card" style="background: rgba(255,255,255,.04); border-radius: 14px; padding:12px; margin-top: 10px;">
        <div style="font-weight:700; margin-bottom:8px;">üìÅ –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –ø–∞–ø–∫—É</div>
        <div class="row">
          <select id="folderSelect" style="flex:1;">
            <option value="">‚Äî –ë–µ–∑ –ø–∞–ø–∫–∏ ‚Äî</option>
          </select>
          <button id="moveToFolderBtn" class="btn primary">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="modalMsg" class="hint"></div>
      </div>

      <div class="kv" id="kv"></div>
    </div>
  </div>

  <!-- Modal: bulk move -->
  <div id="bulkModalBack" class="modalBack">
    <div class="modal" style="width:min(720px,100%)">
      <div class="modalTop">
        <div>
          <div class="title">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</div>
          <div class="hint" id="bulkModalSub">‚Äî</div>
        </div>
        <div class="row">
          <button id="bulkModalClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="card" style="background: rgba(255,255,255,.04); border-radius: 14px; padding:12px;">
        <div class="row" style="align-items:end">
          <div class="field" style="flex:1; min-width: 240px">
            <label>–ü–∞–ø–∫–∞</label>
            <select id="bulkFolderSelect">
              <option value="">‚Äî –ë–µ–∑ –ø–∞–ø–∫–∏ ‚Äî</option>
            </select>
          </div>
          <button id="bulkMoveConfirm" class="btn primary">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="bulkModalMsg" class="hint"></div>
      </div>
    </div>
  </div>

  <!-- Modal: folder create/rename -->
  <div id="folderModalBack" class="modalBack">
    <div class="modal" style="width:min(720px,100%)">
      <div class="modalTop">
        <div>
          <div class="title" id="folderModalTitle">–ü–∞–ø–∫–∞</div>
          <div class="hint" id="folderModalSub">‚Äî</div>
        </div>
        <div class="row">
          <button id="folderModalClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="card" style="background: rgba(255,255,255,.04); border-radius: 14px; padding:12px;">
        <div class="field">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏</label>
          <input id="folderNameInput" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω / –ê–ª–º–∞—Ç—ã" />
        </div>

        <div style="height:10px"></div>

        <div class="field">
          <label>–†–æ–¥–∏—Ç–µ–ª—å (–¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø–∞–ø–æ–∫)</label>
          <select id="folderParentSelect">
            <option value="">‚Äî –ö–æ—Ä–µ–Ω—å ‚Äî</option>
          </select>
        </div>

        <div class="filterFooter">
          <button id="folderModalCancel" class="btn">–û—Ç–º–µ–Ω–∞</button>
          <button id="folderModalSave" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>

        <div id="folderModalMsg" class="hint"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot,
      deleteDoc, doc, updateDoc, addDoc, writeBatch, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQlLh2Abk92sZVCSsYSCxvps4Uld3C1Lk",
      authDomain: "bibonrat.firebaseapp.com",
      databaseURL: "https://bibonrat-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "bibonrat",
      storageBucket: "bibonrat.firebasestorage.app",
      messagingSenderId: "78759159251",
      appId: "1:78759159251:web:3e40d7d5a2aa762f01bb26"
    };

    const DB_NAME = "(default)";
    const CLIENTS_COLLECTION = "Clients";
    const FOLDERS_COLLECTION = "Folders";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DOM ---
    const userPill = document.getElementById("userPill");
    const btnSignOut = document.getElementById("btnSignOut");

    const authBox = document.getElementById("authBox");
    const btnSignIn = document.getElementById("btnSignIn");
    const authMsg = document.getElementById("authMsg");
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("pass");

    const foldersPanel = document.getElementById("foldersPanel");
    const folderListDiv = document.getElementById("folderList");
    const createFolderBtn = document.getElementById("createFolderBtn");
    const foldersEmpty = document.getElementById("foldersEmpty");

    const listPanel = document.getElementById("listPanel");
    const statusLine = document.getElementById("statusLine");
    const tableBody = document.getElementById("tableBody");
    const cardsWrap = document.getElementById("cardsWrap");

    const emptyBox = document.getElementById("empty");
    const emptyTitle = document.getElementById("emptyTitle");
    const emptyText = document.getElementById("emptyText");
    const emptyResetBtn = document.getElementById("emptyResetBtn");

    const filtersBox = document.getElementById("filtersBox");
    const filtersHeader = document.getElementById("filtersHeader");
    const filtersBody = document.getElementById("filtersBody");
    const filtersChevron = document.getElementById("filtersChevron");
    const filtersHeaderMeta = document.getElementById("filtersHeaderMeta");

    const qEl = document.getElementById("q");
    const rangeEl = document.getElementById("range");
    const sortFieldEl = document.getElementById("sortField");
    const sortDirBtn = document.getElementById("sortDirBtn");
    const btnReset = document.getElementById("btnReset");
    const btnApply = document.getElementById("btnApply");

    const kpiTotal = document.getElementById("kpiTotal");
    const kpiGeo = document.getElementById("kpiGeo");

    // Bulk selection
    const bulkBar = document.getElementById("bulkBar");
    const selPill = document.getElementById("selPill");
    const bulkMoveBtn = document.getElementById("bulkMoveBtn");
    const bulkClearBtn = document.getElementById("bulkClearBtn");

    // Modals: client details
    const modalBack = document.getElementById("modalBack");
    const modalClose = document.getElementById("modalClose");
    const modalDelete = document.getElementById("modalDelete");
    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");
    const modalMsg = document.getElementById("modalMsg");
    const modal2gis = document.getElementById("modal2gis");
    const kv = document.getElementById("kv");
    const nameInput = document.getElementById("nameInput");
    const nameSave = document.getElementById("nameSave");
    const copyIdBtn = document.getElementById("copyId");
    const folderSelect = document.getElementById("folderSelect");
    const moveToFolderBtn = document.getElementById("moveToFolderBtn");

    // Modals: bulk move
    const bulkModalBack = document.getElementById("bulkModalBack");
    const bulkModalClose = document.getElementById("bulkModalClose");
    const bulkModalSub = document.getElementById("bulkModalSub");
    const bulkModalMsg = document.getElementById("bulkModalMsg");
    const bulkFolderSelect = document.getElementById("bulkFolderSelect");
    const bulkMoveConfirm = document.getElementById("bulkMoveConfirm");

    // Modals: folder edit
    const folderModalBack = document.getElementById("folderModalBack");
    const folderModalClose = document.getElementById("folderModalClose");
    const folderModalCancel = document.getElementById("folderModalCancel");
    const folderModalSave = document.getElementById("folderModalSave");
    const folderModalTitle = document.getElementById("folderModalTitle");
    const folderModalSub = document.getElementById("folderModalSub");
    const folderModalMsg = document.getElementById("folderModalMsg");
    const folderNameInput = document.getElementById("folderNameInput");
    const folderParentSelect = document.getElementById("folderParentSelect");


    // --- Mobile UI DOM ---
    const qMobile = document.getElementById("qMobile");
    const openFiltersBtn = document.getElementById("openFiltersBtn");
    const folderChips = document.getElementById("folderChips");
    const rangeChips = document.getElementById("rangeChips");

    const navClients = document.getElementById("navClients");
    const navFolders = document.getElementById("navFolders");
    const navFilters = document.getElementById("navFilters");
    const navMore = document.getElementById("navMore");

    const drawerBack = document.getElementById("drawerBack");
    const drawerTitle = document.getElementById("drawerTitle");
    const drawerBody = document.getElementById("drawerBody");
    const drawerClose = document.getElementById("drawerClose");

    // --- localStorage state ---
    const LS_KEY = "fishadmin_state_v2";
    const defaultState = {
      selectedFolder: "ALL", // ALL | NONE | folderId
      filters: { q: "", range: "all", sortField: "date", sortDir: "desc" },
      ui: { filtersCollapsed: false, acc: { search: true, period: true, sort: true } }
    };

    function safeJsonParse(s, fallback){
      try { return JSON.parse(s); } catch { return fallback; }
    }
    function loadState(){
      const saved = safeJsonParse(localStorage.getItem(LS_KEY) || "{}", {});
      return {
        ...defaultState,
        ...saved,
        filters: { ...defaultState.filters, ...(saved.filters || {}) },
        ui: { ...defaultState.ui, ...(saved.ui || {}), acc: { ...defaultState.ui.acc, ...((saved.ui||{}).acc||{}) } },
      };
    }
    let state = loadState();
    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    // --- Utils ---
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }
    function toDateAny(v){
      if(!v) return null;
      if(typeof v === "string"){ const d = new Date(v); return isNaN(d.getTime()) ? null : d; }
      if(typeof v?.toDate === "function") return v.toDate();
      return null;
    }
    function fmt(d){
      if(!d) return "‚Äî";
      return d.toLocaleString("ru-RU", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit" });
    }
    function getLatLng(data){
      const lat = data["–®–∏—Ä–æ—Ç–∞"] ?? data["latitude"] ?? data["lat"];
      const lng = data["–î–æ–ª–≥–æ—Ç–∞"] ?? data["longitude"] ?? data["lng"] ?? data["lon"];
      const latN = lat != null ? Number(lat) : NaN;
      const lngN = lng != null ? Number(lng) : NaN;
      if (Number.isFinite(latN) && Number.isFinite(lngN)) return { lat: latN, lng: lngN };
      return null;
    }
    function to2gisLink(lat, lng){ return `https://2gis.ru/search/${encodeURIComponent(lat + "," + lng)}`; }
    function dataToSearchString(data){
      const parts=[];
      for (const [k,v] of Object.entries(data||{})){ parts.push(String(k)); parts.push(String(v)); }
      return parts.join(" ").toLowerCase();
    }
    function inRange(d, range){
      if(!d) return true;
      const now = Date.now();
      const t = d.getTime();
      if(range === "24h") return t >= now - 24*60*60*1000;
      if(range === "7d") return t >= now - 7*24*60*60*1000;
      if(range === "30d") return t >= now - 30*24*60*60*1000;
      return true;
    }
    function shortLabelFromId(id){ return "K-" + id.slice(0,6).toUpperCase(); }
    function getClientName(id, data){
      const n = (data?.clientName ?? data?.displayName ?? data?.name ?? data?.["–ò–º—è"] ?? "").toString().trim();
      return n ? n : shortLabelFromId(id);
    }

    function clearList(){ tableBody.innerHTML = ""; cardsWrap.innerHTML = ""; }
    function showEmptyBox(show){ emptyBox.style.display = show ? "block" : "none"; }

    // --- Accordions / panels ---
    function setFiltersCollapsed(collapsed){
      state.ui.filtersCollapsed = collapsed;
      saveState();
      if(collapsed){
        filtersBody.style.display = "none";
        filtersChevron.textContent = "üîΩ";
      } else {
        filtersBody.style.display = "block";
        filtersChevron.textContent = "üîº";
      }
    }
    function setupAccordions(){
      document.querySelectorAll(".acc").forEach(acc => {
        const key = acc.dataset.acc;
        const btn = acc.querySelector(".accBtn");
        const open = !!state.ui.acc[key];
        if(open) acc.classList.add("open");
        btn.addEventListener("click", () => {
          const willOpen = !acc.classList.contains("open");
          acc.classList.toggle("open");
          state.ui.acc[key] = willOpen;
          saveState();
        });
      });
    }

    // --- Mobile UI (bottom nav + drawer + swipe chips) ---
    let drawerMode = null;
    const mountInfo = new Map(); // node -> {parent, next}

    function setActiveNav(key){
      const map = { clients: navClients, folders: navFolders, filters: navFilters, more: navMore };
      Object.entries(map).forEach(([k, el]) => {
        if(!el) return;
        el.classList.toggle("active", k === key);
      });
    }

    function rememberMount(node){
      if(!node || mountInfo.has(node)) return;
      mountInfo.set(node, { parent: node.parentNode, next: node.nextSibling });
    }

    function mountToDrawer(node){
      if(!node) return;
      rememberMount(node);
      node.classList.add("inDrawer");
      drawerBody.appendChild(node);
      node.style.display = "block";
    }

    function restoreFromDrawer(node){
      if(!node) return;
      const info = mountInfo.get(node);
      node.classList.remove("inDrawer");
      if(!info || !info.parent) return;
      if(info.next) info.parent.insertBefore(node, info.next);
      else info.parent.appendChild(node);
    }

    function openDrawer(mode){
      if(!drawerBack || !drawerBody) return;
      drawerMode = mode;
      drawerBody.innerHTML = "";
      drawerBack.style.display = "flex";
      drawerBack.setAttribute("aria-hidden", "false");
      document.body.classList.add("drawerOpen");

      if(mode === "folders"){
        drawerTitle.textContent = "–ü–∞–ø–∫–∏";
        mountToDrawer(foldersPanel);
      } else if(mode === "filters"){
        drawerTitle.textContent = "–§–∏–ª—å—Ç—Ä—ã";
        mountToDrawer(rightPanel);
        // –Ω–∞ –≤—Å—è–∫–∏–π ‚Äî —Å–∫—Ä–æ–ª–ª –Ω–∞ –Ω–∞—á–∞–ª–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        const el = document.getElementById("filtersHeader");
        el && el.scrollIntoView({block:"start"});
      } else if(mode === "more"){
        drawerTitle.textContent = "–ï—â—ë";
        const box = document.createElement("div");
        box.className = "card";
        box.style.background = "rgba(255,255,255,.04)";
        box.style.borderRadius = "14px";
        box.style.padding = "12px";
        const email = (userPill?.textContent || "").replace("–í–æ—à–ª–∏:", "").trim();
        box.innerHTML = `
          <div style="font-weight:900; font-size:16px; margin-bottom:8px;">–ê–∫–∫–∞—É–Ω—Ç</div>
          <div class="hint" style="margin-top:0">–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</div>
          <div class="pill" style="margin-top:8px; max-width:100%">${email ? email : "‚Äî"}</div>
          <div style="height:12px"></div>
          <button id="sheetSignOut" class="btn danger" style="width:100%">–í—ã–π—Ç–∏</button>
          <div class="hint" style="margin-top:10px">–ö–æ–Ω—Ñ–∏–≥ Firestore/–∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å–ø—Ä—è—Ç–∞–Ω—ã –≤ —à–∞–ø–∫–µ –Ω–∞ –º–æ–±–∏–ª–µ ‚Äî —á—Ç–æ–±—ã –Ω–µ —à—É–º–µ—Ç—å.</div>
        `;
        drawerBody.appendChild(box);
        setTimeout(() => {
          const b = document.getElementById("sheetSignOut");
          b && b.addEventListener("click", () => btnSignOut?.click());
        }, 0);
      }
    }

    function closeDrawer(){
      if(!drawerBack) return;
      drawerBack.style.display = "none";
      drawerBack.setAttribute("aria-hidden", "true");
      document.body.classList.remove("drawerOpen");

      if(drawerMode === "folders") restoreFromDrawer(foldersPanel);
      if(drawerMode === "filters") restoreFromDrawer(rightPanel);

      drawerBody && (drawerBody.innerHTML = "");
      drawerMode = null;
      setActiveNav("clients");
    }

    function isMobile(){
      return window.matchMedia && window.matchMedia("(max-width: 767px)").matches;
    }

    function syncRangeChips(){
      if(!rangeChips) return;
      const active = state.filters.range || "all";
      rangeChips.querySelectorAll("[data-range]").forEach(b => {
        b.classList.toggle("selected", b.getAttribute("data-range") === active);
      });
    }

    function renderFolderChips(){
      if(!folderChips) return;
      const { counts, none } = countByFolderId();
      const selected = state.selectedFolder;

      const top = folderOrder.filter(f => f.depth === 0).slice(0, 4); // 4 + (–í—Å–µ/–ë–µ–∑) = 6 –º–∞–∫—Å
      const chips = [];

      const mk = (key, label, count) => {
        const sel = selected === key ? "selected" : "";
        const countHtml = (count != null) ? `<span class="chipCount">${count}</span>` : "";
        chips.push(`<button class="chip ${sel}" type="button" data-folderkey="${escapeHtml(key)}">${escapeHtml(label)} ${countHtml}</button>`);
      };

      mk("ALL", "–í—Å–µ", raw.length);
      mk("NONE", "–ë–µ–∑ –ø–∞–ø–∫–∏", none);

      for(const f of top){
        mk(f.id, f.name, counts.get(f.id) || 0);
      }

      chips.push(`<button class="chip" type="button" data-openfolders="1">–ï—â—ë</button>`);
      folderChips.innerHTML = chips.join("");

      folderChips.querySelectorAll("[data-folderkey]").forEach(el => {
        el.addEventListener("click", () => {
          const key = el.getAttribute("data-folderkey");
          state.selectedFolder = key;
          saveState();
          renderFolders();
          applyFiltersAndRender();
        });
      });
      const moreBtn = folderChips.querySelector("[data-openfolders]");
      moreBtn && moreBtn.addEventListener("click", () => openDrawer("folders"));
    }

    // Bind mobile controls
    drawerClose && drawerClose.addEventListener("click", closeDrawer);
    drawerBack && drawerBack.addEventListener("click", (e) => { if(e.target === drawerBack) closeDrawer(); });

    navClients && navClients.addEventListener("click", () => { closeDrawer(); setActiveNav("clients"); });
    navFolders && navFolders.addEventListener("click", () => { setActiveNav("folders"); openDrawer("folders"); });
    navFilters && navFilters.addEventListener("click", () => { setActiveNav("filters"); openDrawer("filters"); });
    navMore && navMore.addEventListener("click", () => { setActiveNav("more"); openDrawer("more"); });

    openFiltersBtn && openFiltersBtn.addEventListener("click", () => openDrawer("filters"));

    qMobile && qMobile.addEventListener("input", () => {
      state.filters.q = (qMobile.value || "").trim();
      qEl.value = state.filters.q;
      saveState();
      updateAccMeta();
      updateFiltersHeaderMeta();
      applyFiltersAndRender();
    });

    rangeChips && rangeChips.querySelectorAll("[data-range]").forEach(b => {
      b.addEventListener("click", () => {
        state.filters.range = b.getAttribute("data-range") || "all";
        rangeEl.value = state.filters.range;
        saveState();
        updateAccMeta();
        updateFiltersHeaderMeta();
        syncRangeChips();
        applyFiltersAndRender();
      });
    });

    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && drawerMode) closeDrawer();
    });


    // --- Data state ---
    let unsubClients = null;
    let unsubFolders = null;

    let raw = []; // {id, data}
    let foldersArr = []; // {id, ...data}
    let foldersById = {}; // id -> {id,name,parentId}
    let folderChildren = new Map(); // parentId -> [folder]
    let folderOrder = []; // flat list with depth for options rendering

    let selectedIds = new Set(); // multi-select

    // --- Folder helpers ---
    function buildFolderIndex(){
      foldersById = {};
      folderChildren = new Map();
      for(const f of foldersArr){
        foldersById[f.id] = { id: f.id, name: (f.name||"").toString(), parentId: f.parentId || null };
      }
      for(const f of Object.values(foldersById)){
        const p = f.parentId || "";
        if(!folderChildren.has(p)) folderChildren.set(p, []);
        folderChildren.get(p).push(f);
      }
      // Sort children by name
      for(const [k, arr] of folderChildren.entries()){
        arr.sort((a,b)=> (a.name||"").localeCompare((b.name||""), "ru"));
      }

      folderOrder = [];
      function walk(parentKey, depth){
        const children = folderChildren.get(parentKey) || [];
        for(const c of children){
          folderOrder.push({ ...c, depth });
          walk(c.id, depth+1);
        }
      }
      walk("", 0);
    }

    function folderPath(folderId){
      const parts = [];
      let cur = foldersById[folderId];
      let guard = 0;
      while(cur && guard < 50){
        parts.unshift(cur.name);
        cur = cur.parentId ? foldersById[cur.parentId] : null;
        guard++;
      }
      return parts.join(" / ");
    }

    function getFolderLabelForClient(data){
      const fid = data?.folderId;
      if(fid && foldersById[fid]) return folderPath(fid);
      // compatibility: old string field
      const legacy = (data?.folder ?? "").toString().trim();
      if(legacy) return legacy;
      return "‚Äî";
    }

    function countByFolderId(){
      const counts = new Map();
      let none = 0;
      for(const {data} of raw){
        const fid = data.folderId;
        if(fid){ counts.set(fid, (counts.get(fid)||0) + 1); }
        else none++;
      }
      return { counts, none };
    }

    function renderFolders(){
      buildFolderIndex();
      const { counts, none } = countByFolderId();

      const selected = state.selectedFolder;
      let html = "";

      const allCount = raw.length;

      const mkBaseItem = (key, icon, label, count) => {
        const sel = selected === key ? "selected" : "";
        return `
          <div class="folder-item ${sel}" data-folderkey="${key}" data-drop="1">
            <div class="folder-left">
              <span>${icon}</span>
              <span class="folder-name">${escapeHtml(label)}</span>
            </div>
            <div class="folder-actions">
              <span class="folder-count">${count}</span>
            </div>
          </div>
        `;
      };

      html += mkBaseItem("ALL", "üìÇ", "–í—Å–µ", allCount);
      html += mkBaseItem("NONE", "üì≠", "–ë–µ–∑ –ø–∞–ø–∫–∏", none);

      if(folderOrder.length === 0){
        foldersEmpty.style.display = "block";
      } else {
        foldersEmpty.style.display = "none";
      }

      for(const f of folderOrder){
        const sel = selected === f.id ? "selected" : "";
        const count = counts.get(f.id) || 0;
        const pad = 10 + f.depth * 14;
        html += `
          <div class="folder-item ${sel}" data-folderkey="${escapeHtml(f.id)}" data-drop="1" style="padding-left:${pad}px">
            <div class="folder-left">
              <span>üìÅ</span>
              <span class="folder-name" title="${escapeHtml(folderPath(f.id))}">${escapeHtml(f.name)}</span>
            </div>
            <div class="folder-actions">
              <span class="folder-count">${count}</span>
              <button class="iconBtn" data-folder-rename="${escapeHtml(f.id)}" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
              <button class="iconBtn" data-folder-del="${escapeHtml(f.id)}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }

      folderListDiv.innerHTML = html;

      // click handlers (select folder)
      folderListDiv.querySelectorAll(".folder-item").forEach(el => {
        el.addEventListener("click", (e) => {
          const renameBtn = e.target.closest("[data-folder-rename]");
          const delBtn = e.target.closest("[data-folder-del]");
          if(renameBtn || delBtn) return; // handled below
          const key = el.dataset.folderkey;
          state.selectedFolder = key;
          saveState();
          renderFolders();
          applyFiltersAndRender();
        });

        // drag & drop target
        el.addEventListener("dragover", (e) => {
          e.preventDefault();
          el.classList.add("dragOver");
        });
        el.addEventListener("dragleave", () => el.classList.remove("dragOver"));
        el.addEventListener("drop", async (e) => {
          e.preventDefault();
          el.classList.remove("dragOver");
          const payload = e.dataTransfer.getData("text/plain");
          if(!payload) return;
          let ids = [];
          try { ids = JSON.parse(payload); } catch { ids = []; }
          if(!Array.isArray(ids) || ids.length === 0) return;

          const key = el.dataset.folderkey;
          if(key === "ALL") return;
          const toFolderId = key === "NONE" ? null : key;
          await moveClientsToFolder(ids, toFolderId);
        });
      });

      // rename/delete buttons
      folderListDiv.querySelectorAll("[data-folder-rename]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          openFolderModal({ mode: "rename", folderId: btn.dataset.folderRename });
        });
      });
      folderListDiv.querySelectorAll("[data-folder-del]").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          e.stopPropagation();
          const id = btn.dataset.folderDel;
          await deleteFolderFlow(id);
        });
      });

      // update folder selects (client modal + bulk modal + folder parent select)
      rebuildFolderSelects();
      renderFolderChips();
    }

    function rebuildFolderSelects(){
      const optMove = [];
      optMove.push(`<option value="">‚Äî –ë–µ–∑ –ø–∞–ø–∫–∏ ‚Äî</option>`);
      for(const f of folderOrder){
        const indent = "‚Äî".repeat(Math.min(6, f.depth+1)) + " ";
        optMove.push(`<option value="${escapeHtml(f.id)}">${escapeHtml(indent + f.name)}</option>`);
      }
      const htmlMove = optMove.join("");
      folderSelect.innerHTML = htmlMove;
      bulkFolderSelect.innerHTML = htmlMove;

      const optParent = [];
      optParent.push(`<option value="">‚Äî –ö–æ—Ä–µ–Ω—å ‚Äî</option>`);
      for(const f of folderOrder){
        const indent = "‚Äî".repeat(Math.min(6, f.depth+1)) + " ";
        optParent.push(`<option value="${escapeHtml(f.id)}">${escapeHtml(indent + f.name)}</option>`);
      }
      folderParentSelect.innerHTML = optParent.join("");
    }

    // --- Folder CRUD flows ---
    let folderModalState = { mode: "create", folderId: null };
    function openFolderModal({mode, folderId}){
      folderModalState = { mode, folderId: folderId || null };

      folderModalMsg.textContent = "";
      folderNameInput.value = "";
      folderParentSelect.value = "";

      if(mode === "create"){
        folderModalTitle.textContent = "–°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É";
        const parentCandidate = (state.selectedFolder !== "ALL" && state.selectedFolder !== "NONE") ? state.selectedFolder : "";
        folderParentSelect.value = parentCandidate || "";
        folderModalSub.textContent = parentCandidate && foldersById[parentCandidate]
          ? `–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –≤–Ω—É—Ç—Ä–∏: ${folderPath(parentCandidate)}`
          : "–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –≤ –∫–æ—Ä–Ω–µ";
      } else {
        const f = foldersById[folderId];
        folderModalTitle.textContent = "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–∞–ø–∫—É";
        folderModalSub.textContent = f ? `–¢–µ–∫—É—â–∏–π –ø—É—Ç—å: ${folderPath(folderId)}` : "‚Äî";
        if(f){
          folderNameInput.value = f.name || "";
          folderParentSelect.value = f.parentId || "";
        }
      }
      folderModalBack.style.display = "flex";
      setTimeout(() => folderNameInput.focus(), 50);
    }
    function closeFolderModal(){
      folderModalBack.style.display = "none";
    }

    folderModalClose.addEventListener("click", closeFolderModal);
    folderModalCancel.addEventListener("click", closeFolderModal);
    folderModalBack.addEventListener("click", (e) => { if(e.target === folderModalBack) closeFolderModal(); });

    folderModalSave.addEventListener("click", async () => {
      const name = (folderNameInput.value || "").trim();
      const parentId = folderParentSelect.value || null;

      if(!name){
        folderModalMsg.innerHTML = `<span class="dangerText">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.</span>`;
        return;
      }
      // basic cycle prevention on rename
      if(folderModalState.mode === "rename" && folderModalState.folderId){
        if(parentId === folderModalState.folderId){
          folderModalMsg.innerHTML = `<span class="dangerText">–ü–∞–ø–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–æ–¥–∏—Ç–µ–ª–µ–º —Å–∞–º–∞ —Å–µ–±–µ.</span>`;
          return;
        }
        // also prevent setting parent to descendant
        const targetId = folderModalState.folderId;
        let cur = parentId ? foldersById[parentId] : null;
        let guard = 0;
        while(cur && guard < 50){
          if(cur.id === targetId){
            folderModalMsg.innerHTML = `<span class="dangerText">–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ø–∞–ø–∫—É –≤–Ω—É—Ç—Ä—å –µ—ë –¥–æ—á–µ—Ä–Ω–µ–π.</span>`;
            return;
          }
          cur = cur.parentId ? foldersById[cur.parentId] : null;
          guard++;
        }
      }

      try{
        folderModalMsg.textContent = "‚è≥ –°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶";
        if(folderModalState.mode === "create"){
          await addDoc(collection(db, FOLDERS_COLLECTION), {
            name,
            parentId: parentId || null,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          folderModalMsg.innerHTML = `<span class="ok">‚úÖ –ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞</span>`;
          setTimeout(closeFolderModal, 350);
        } else {
          await updateDoc(doc(db, FOLDERS_COLLECTION, folderModalState.folderId), {
            name,
            parentId: parentId || null,
            updatedAt: serverTimestamp()
          });
          folderModalMsg.innerHTML = `<span class="ok">‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ</span>`;
          setTimeout(closeFolderModal, 350);
        }
      } catch(err){
        folderModalMsg.innerHTML = `<span class="dangerText">‚ùå ${escapeHtml(err?.message || err)}</span>`;
      }
    });

    createFolderBtn.addEventListener("click", () => openFolderModal({ mode: "create" }));

    async function deleteFolderFlow(folderId){
      const f = foldersById[folderId];
      if(!f){ alert("–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."); return; }

      const hasChildren = (folderChildren.get(folderId) || []).length > 0;
      if(hasChildren){
        alert("–í –ø–∞–ø–∫–µ –µ—Å—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–∞–ø–∫–∏. –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–∏—Ç–µ/–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –∏—Ö.");
        return;
      }

      const clientsInFolder = raw.filter(x => x.data.folderId === folderId).map(x => x.id);

      let msg = `–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É ‚Äú${f.name}‚Äù?`;
      if(clientsInFolder.length > 0){
        msg += `\n\n–í –ø–∞–ø–∫–µ ${clientsInFolder.length} —ç–ª–µ–º–µ–Ω—Ç(–æ–≤). –ò—Ö –º–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ ‚Äú–ë–µ–∑ –ø–∞–ø–∫–∏‚Äù, –∑–∞—Ç–µ–º —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É.`;
      }
      if(!confirm(msg)) return;

      try{
        if(clientsInFolder.length > 0){
          if(!confirm(`–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å ${clientsInFolder.length} —ç–ª–µ–º–µ–Ω—Ç(–æ–≤) –≤ ‚Äú–ë–µ–∑ –ø–∞–ø–∫–∏‚Äù?`)) return;
          await moveClientsToFolder(clientsInFolder, null, {silent:true});
        }
        await deleteDoc(doc(db, FOLDERS_COLLECTION, folderId));
      } catch(err){
        alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞–ø–∫–∏: " + (err?.message || err));
      }
    }

    // --- Filters state wiring ---
    function applyStateToInputs(){
      qEl.value = state.filters.q;
      if(qMobile) qMobile.value = state.filters.q;
      rangeEl.value = state.filters.range;
      syncRangeChips();
      sortFieldEl.value = state.filters.sortField;

      sortDirBtn.textContent = state.filters.sortDir === "asc" ? "‚¨ÜÔ∏è –≤–æ–∑—Ä." : "‚¨áÔ∏è —É–±—ã–≤.";
      setFiltersCollapsed(!!state.ui.filtersCollapsed);

      updateAccMeta();
      updateFiltersHeaderMeta();
    }

    function captureInputsToState(){
      state.filters.q = (qEl.value || "").trim();
      if(qMobile) qMobile.value = state.filters.q;
      state.filters.range = rangeEl.value || "all";
      syncRangeChips();
      state.filters.sortField = sortFieldEl.value || "date";
      saveState();
      updateAccMeta();
      updateFiltersHeaderMeta();
    }

    function resetFilters(){
      state.filters = { ...defaultState.filters };
      saveState();
      applyStateToInputs();
      applyFiltersAndRender();
    }

    sortDirBtn.addEventListener("click", () => {
      state.filters.sortDir = state.filters.sortDir === "asc" ? "desc" : "asc";
      saveState();
      applyStateToInputs();
      applyFiltersAndRender();
    });

    btnApply.addEventListener("click", () => {
      captureInputsToState();
      applyFiltersAndRender();
    });
    btnReset.addEventListener("click", resetFilters);
    emptyResetBtn.addEventListener("click", resetFilters);

    // If you want instant filtering, keep listeners:
    qEl.addEventListener("input", () => { captureInputsToState(); applyFiltersAndRender(); });
    rangeEl.addEventListener("change", () => { captureInputsToState(); applyFiltersAndRender(); });
    sortFieldEl.addEventListener("change", () => { captureInputsToState(); applyFiltersAndRender(); });

    filtersHeader.addEventListener("click", () => setFiltersCollapsed(!state.ui.filtersCollapsed));

    function updateAccMeta(){
      const q = (state.filters.q || "");
      document.getElementById("accMetaSearch").textContent = q ? `‚Äú${q.slice(0,22)}${q.length>22?"‚Ä¶":""}‚Äù` : "‚Äî";
      document.getElementById("accMetaPeriod").textContent = rangeEl.options[rangeEl.selectedIndex]?.textContent || "‚Äî";

      const fieldLabel = sortFieldEl.options[sortFieldEl.selectedIndex]?.textContent || "‚Äî";
      const dirLabel = state.filters.sortDir === "asc" ? "–≤–æ–∑—Ä." : "—É–±—ã–≤.";
      document.getElementById("accMetaSort").textContent = `${fieldLabel} ‚Ä¢ ${dirLabel}`;
    }
    function updateFiltersHeaderMeta(){
      const active = [];
      if(state.filters.q) active.push("–ø–æ–∏—Å–∫");
      if(state.filters.range !== "all") active.push("–ø–µ—Ä–∏–æ–¥");
      if(state.filters.sortField !== "date" || state.filters.sortDir !== "desc") active.push("—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞");
      filtersHeaderMeta.textContent = active.length ? `–∞–∫—Ç–∏–≤–Ω–æ: ${active.join(", ")}` : "–Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ";
    }

    // --- Selection ---
    function updateBulkUI(){
      const n = selectedIds.size;
      if(n > 0){
        bulkBar.style.display = "flex";
        selPill.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${n}`;
      } else {
        bulkBar.style.display = "none";
        selPill.textContent = "–í—ã–±—Ä–∞–Ω–æ: 0";
      }
      // Update checkboxes visual state
      document.querySelectorAll("[data-sel]").forEach(ch => {
        const id = ch.getAttribute("data-sel");
        ch.checked = selectedIds.has(id);
      });
    }

    function toggleSelection(id, checked){
      if(checked) selectedIds.add(id); else selectedIds.delete(id);
      updateBulkUI();
    }
    function clearSelection(){
      selectedIds.clear();
      updateBulkUI();
    }

    bulkClearBtn.addEventListener("click", clearSelection);

    // Bulk move modal
    function openBulkModal(){
      bulkModalMsg.textContent = "";
      bulkModalSub.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selectedIds.size}`;
      bulkFolderSelect.value = "";
      bulkModalBack.style.display = "flex";
    }
    function closeBulkModal(){ bulkModalBack.style.display = "none"; }
    bulkMoveBtn.addEventListener("click", openBulkModal);
    bulkModalClose.addEventListener("click", closeBulkModal);
    bulkModalBack.addEventListener("click", (e) => { if(e.target === bulkModalBack) closeBulkModal(); });

    bulkMoveConfirm.addEventListener("click", async () => {
      const ids = Array.from(selectedIds);
      if(ids.length === 0) return;
      const toFolderId = bulkFolderSelect.value || null;
      await moveClientsToFolder(ids, toFolderId);
      closeBulkModal();
      clearSelection();
    });

    // --- Rendering ---
    function setEmptyState(kind){
      // kind: "noItems" | "noResults"
      if(kind === "noItems"){
        emptyTitle.textContent = "–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤";
        emptyText.textContent = "–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ Clients –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.";
      } else {
        emptyTitle.textContent = "–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤";
        emptyText.textContent = "–ü–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º/–ø–∞–ø–∫–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –ø–∞–ø–∫—É.";
      }
      showEmptyBox(true);
    }

    function applyFiltersAndRender(){
      const needle = (state.filters.q || "").trim().toLowerCase();
      const range = state.filters.range;
      const sortField = state.filters.sortField;
      const sortDir = state.filters.sortDir;

      const folderKey = state.selectedFolder;

      let filtered = raw.filter(({data}) => {
        // folder filter
        if(folderKey === "NONE"){
          if(data.folderId) return false;
        } else if(folderKey !== "ALL"){
          if(data.folderId !== folderKey) return false;
        }
        const d = toDateAny(data.timestamp);
        if(!inRange(d, range)) return false;
        if(!needle) return true;
        return dataToSearchString(data).includes(needle);
      });

      // Sort
      filtered.sort((a,b) => {
        const da = toDateAny(a.data.timestamp);
        const db = toDateAny(b.data.timestamp);

        const nameA = getClientName(a.id, a.data).toLowerCase();
        const nameB = getClientName(b.id, b.data).toLowerCase();

        const folderA = getFolderLabelForClient(a.data).toLowerCase();
        const folderB = getFolderLabelForClient(b.data).toLowerCase();

        let cmp = 0;
        switch(sortField){
          case "date": cmp = (da?.getTime() || 0) - (db?.getTime() || 0); break;
          case "name": cmp = nameA.localeCompare(nameB, "ru"); break;
          case "folder": cmp = folderA.localeCompare(folderB, "ru"); break;
          default: cmp = 0;
        }
        return sortDir === "asc" ? cmp : -cmp;
      });

      // KPIs
      kpiTotal.textContent = String(filtered.length);
      const geoCount = filtered.reduce((acc, it) => acc + (getLatLng(it.data) ? 1 : 0), 0);
      kpiGeo.textContent = String(geoCount);

      clearList();
      showEmptyBox(false);

      if(raw.length === 0){
        setEmptyState("noItems");
        return;
      }
      if(filtered.length === 0){
        setEmptyState("noResults");
        return;
      }

      // Desktop
      for(const {id, data} of filtered){
        const tr = document.createElement("tr");
        tr.draggable = true;
        tr.dataset.dragId = id;

        const dt = toDateAny(data.timestamp);
        const ua = data["User Agent"] ?? data["userAgent"] ?? "‚Äî";
        const plat = data["–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞"] ?? data["platform"] ?? "‚Äî";
        const ll = getLatLng(data);
        const clientName = getClientName(id, data);
        const folderLabel = getFolderLabelForClient(data);

        tr.innerHTML = `
          <td>
            <input class="chk" type="checkbox" data-sel="${escapeHtml(id)}" />
          </td>
          <td class="mono">${escapeHtml(fmt(dt))}</td>
          <td>
            <div><b>${escapeHtml(clientName)}</b></div>
            <div class="hint mono">ID: ${escapeHtml(shortLabelFromId(id))}</div>
          </td>
          <td>
            <div><b>${escapeHtml(plat)}</b></div>
            <div style="color:var(--muted); font-size:12px">${escapeHtml(String(ua).slice(0, 120))}${String(ua).length > 120 ? "‚Ä¶" : ""}</div>
          </td>
          <td>
            ${ll ? `<a class="linkBtn" target="_blank" rel="noopener" href="${to2gisLink(ll.lat, ll.lng)}">2GIS</a>
                   <div class="hint mono" style="margin-top:6px">${ll.lat.toFixed(6)}, ${ll.lng.toFixed(6)}</div>`
                : `<span class="hint">‚Äî</span>`}
          </td>
          <td><span class="badge">üìÅ ${escapeHtml(folderLabel)}</span></td>
          <td style="white-space:nowrap">
            <button class="btn primary" data-open="${escapeHtml(id)}">–û—Ç–∫—Ä—ã—Ç—å</button>
            <button class="btn danger" data-del="${escapeHtml(id)}">–£–¥–∞–ª–∏—Ç—å</button>
          </td>
        `;
        tableBody.appendChild(tr);
      }

      // Mobile cards
      for(const {id, data} of filtered){
        const dt = toDateAny(data.timestamp);
        const lang = data["–Ø–∑—ã–∫"] ?? data["language"] ?? "‚Äî";
        const ll = getLatLng(data);
        const clientName = getClientName(id, data);
        const folderLabel = getFolderLabelForClient(data);

        const card = document.createElement("div");
        card.className = "clientCard";
        card.draggable = true;
        card.dataset.dragId = id;

        const initial = (clientName || "K").trim().slice(0,1).toUpperCase();
        card.innerHTML = `
          <div class="clientHead">
            <div style="display:flex; gap:10px; align-items:flex-start; min-width:0">
              <div style="width:36px; height:36px; border-radius:14px; border:1px solid var(--line); background:rgba(255,255,255,.05); display:flex; align-items:center; justify-content:center; font-weight:900; flex:0 0 auto">${escapeHtml(initial)}</div>
              <div class="clientTitle" style="min-width:0">
                <div class="main" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${escapeHtml(clientName)}</div>
                <div class="sub">${escapeHtml(fmt(dt))} ‚Ä¢ <span class="mono">${escapeHtml(shortLabelFromId(id))}</span></div>
              </div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
              <input class="chk" type="checkbox" data-sel="${escapeHtml(id)}" />
              <div class="badge">${ll ? "üìç GEO" : "‚Äî"}</div>
            </div>
          </div>

          <div class="miniRow">
            <div class="mini"><b>–Ø–∑—ã–∫:</b> ${escapeHtml(lang)}</div>
            <div class="mini"><b>–ü–∞–ø–∫–∞:</b> ${escapeHtml(folderLabel)}</div>
          </div>

          <div class="links">
            ${ll ? `<a class="linkBtn" target="_blank" rel="noopener" href="${to2gisLink(ll.lat, ll.lng)}">–û—Ç–∫—Ä—ã—Ç—å 2GIS</a>` : ""}
            <a class="linkBtn" href="#" data-open="${escapeHtml(id)}">–î–µ—Ç–∞–ª–∏</a>
            <a class="linkBtn dangerText" href="#" data-del="${escapeHtml(id)}">–£–¥–∞–ª–∏—Ç—å</a>
          </div>
        `;
        cardsWrap.appendChild(card);
      }

      // Bind checkboxes
      document.querySelectorAll("[data-sel]").forEach(ch => {
        const id = ch.getAttribute("data-sel");
        ch.checked = selectedIds.has(id);
        ch.addEventListener("change", () => toggleSelection(id, ch.checked));
      });

      // Bind open/delete
      document.querySelectorAll("[data-open]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          const id = btn.getAttribute("data-open");
          const found = raw.find(x => x.id === id);
          if(found) openClientModal(found.id, found.data);
        });
      });

      document.querySelectorAll("[data-del]").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          e.preventDefault();
          const id = btn.getAttribute("data-del");
          if(!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
          try{
            await deleteDoc(doc(db, CLIENTS_COLLECTION, id));
          } catch(err){
            alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + (err?.message || err));
          }
        });
      });

      // Drag handlers on rows/cards
      document.querySelectorAll("[data-drag-id]").forEach(el => {
        el.addEventListener("dragstart", (e) => {
          const id = el.dataset.dragId;
          const ids = selectedIds.has(id) ? Array.from(selectedIds) : [id];
          // If dragging an unselected item, implicitly select only it (common UX)
          if(!selectedIds.has(id)){
            selectedIds.clear();
            selectedIds.add(id);
            updateBulkUI();
          }
          e.dataTransfer.setData("text/plain", JSON.stringify(ids));
          e.dataTransfer.effectAllowed = "move";
        });
      });

      updateBulkUI();
    }

    // --- Firestore updates: moving clients ---
    async function moveClientsToFolder(clientIds, folderId, opts={silent:false}){
      if(!clientIds || clientIds.length === 0) return;
      const fName = folderId && foldersById[folderId] ? foldersById[folderId].name : null;

      try{
        if(!opts.silent){
          statusLine.textContent = "‚è≥ –ü–µ—Ä–µ–º–µ—â–∞—é‚Ä¶";
        }
        const batch = writeBatch(db);
        for(const id of clientIds){
          batch.update(doc(db, CLIENTS_COLLECTION, id), {
            folderId: folderId || null,
            folder: fName || null,
            folderUpdatedAt: serverTimestamp()
          });
        }
        await batch.commit();
        if(!opts.silent){
          statusLine.textContent = "‚úÖ –ü–µ—Ä–µ–º–µ—â–µ–Ω–æ";
          setTimeout(() => statusLine.textContent = `üü¢ –ì–æ—Ç–æ–≤–æ ‚Ä¢ ${raw.length} –∑–∞–ø–∏—Å–µ–π`, 600);
        }
      } catch(err){
        if(!opts.silent){
          alert("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è: " + (err?.message || err));
          statusLine.textContent = `üü¢ –ì–æ—Ç–æ–≤–æ ‚Ä¢ ${raw.length} –∑–∞–ø–∏—Å–µ–π`;
        } else {
          throw err;
        }
      }
    }

    // --- Client modal ---
    let currentDocId = null;
    let currentData = null;

    function openClientModal(id, data){
      currentDocId = id;
      currentData = data;
      modalMsg.textContent = "";

      const clientName = getClientName(id, data);
      const dt = toDateAny(data.timestamp);

      modalTitle.textContent = `–ö–ª–∏–µ–Ω—Ç: ${clientName}`;
      modalSub.textContent = `ID: ${id} ‚Ä¢ –í—Ä–µ–º—è: ${fmt(dt)} ‚Ä¢ –ü–æ–ª–µ–π: ${Object.keys(data).length}`;

      nameInput.value = (data.clientName ?? data.displayName ?? data.name ?? data["–ò–º—è"] ?? "").toString();

      const ll = getLatLng(data);
      if(ll){
        modal2gis.style.display = "inline-block";
        modal2gis.href = to2gisLink(ll.lat, ll.lng);
      } else {
        modal2gis.style.display = "none";
        modal2gis.removeAttribute("href");
      }

      // set folder
      folderSelect.value = data.folderId || "";
      kv.innerHTML = "";
      const entries = Object.entries(data).sort(([a],[b]) => a.localeCompare(b, "ru"));
      for(const [k,v] of entries){
        const item = document.createElement("div");
        item.className = "item";
        const val = (typeof v === "object" && v?.seconds != null && v?.nanoseconds != null)
          ? fmt(toDateAny(v))
          : String(v);
        const isLong = String(val).length > 180;
        item.innerHTML = `
          <div class="k">${escapeHtml(k)}</div>
          <div class="v ${isLong ? 'vClamp' : ''}">${escapeHtml(val)}</div>
          ${isLong ? `<button class="btn ghost" type="button" data-more="1" style="padding:8px 10px; margin-top:8px; width:100%">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>` : ``}
        `;
        kv.appendChild(item);
      }

      // Read more toggles in modal
      kv.querySelectorAll('[data-more="1"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const v = btn.parentElement.querySelector('.v');
          const expanded = !v.classList.contains('vClamp');
          if(expanded){
            v.classList.add('vClamp');
            btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë';
          } else {
            v.classList.remove('vClamp');
            btn.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
          }
        });
      });

      modalBack.style.display = "flex";
    }

    function closeClientModal(){
      modalBack.style.display = "none";
      currentDocId = null;
      currentData = null;
    }

    modalClose.addEventListener("click", closeClientModal);
    modalBack.addEventListener("click", (e) => { if(e.target === modalBack) closeClientModal(); });

    nameSave.addEventListener("click", async () => {
      if(!currentDocId) return;
      const val = nameInput.value.trim();
      try{
        await updateDoc(doc(db, CLIENTS_COLLECTION, currentDocId), { clientName: val });
        modalMsg.innerHTML = `<span class="ok">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>`;
      } catch(err){
        modalMsg.innerHTML = `<span class="dangerText">‚ùå ${escapeHtml(err?.message || err)}</span>`;
      }
    });

    copyIdBtn.addEventListener("click", async () => {
      if(!currentDocId) return;
      try{
        await navigator.clipboard.writeText(currentDocId);
        modalMsg.innerHTML = `<span class="ok">‚úÖ ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω</span>`;
      } catch {
        modalMsg.innerHTML = `<span class="dangerText">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>`;
      }
    });

    moveToFolderBtn.addEventListener("click", async () => {
      if(!currentDocId) return;
      const newFolderId = folderSelect.value || null;
      try{
        await moveClientsToFolder([currentDocId], newFolderId);
        modalMsg.innerHTML = `<span class="ok">‚úÖ –ü–µ—Ä–µ–º–µ—â–µ–Ω–æ</span>`;
        if(currentData){
          currentData.folderId = newFolderId;
          currentData.folder = newFolderId && foldersById[newFolderId] ? foldersById[newFolderId].name : null;
        }
      } catch(err){
        modalMsg.innerHTML = `<span class="dangerText">‚ùå ${escapeHtml(err?.message || err)}</span>`;
      }
    });

    modalDelete.addEventListener("click", async () => {
      if(!currentDocId) return;
      if(!confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
      try{
        await deleteDoc(doc(db, CLIENTS_COLLECTION, currentDocId));
        modalMsg.innerHTML = `<span class="ok">‚úÖ –£–¥–∞–ª–µ–Ω–æ</span>`;
        setTimeout(closeClientModal, 400);
      } catch(err){
        modalMsg.innerHTML = `<span class="dangerText">‚ùå ${escapeHtml(err?.message || err)}</span>`;
      }
    });

    // --- Auth ---
    btnSignIn.addEventListener("click", async () => {
      authMsg.textContent = "";
      const email = emailEl.value.trim();
      const pass = passEl.value.trim();
      if(!email || !pass){
        authMsg.innerHTML = `<span class="dangerText">–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å.</span>`;
        return;
      }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      } catch(err){
        authMsg.innerHTML = `<span class="dangerText">${escapeHtml(err?.message || err)}</span>`;
      }
    });

    btnSignOut.addEventListener("click", async () => { await signOut(auth); });

    // --- Subscriptions ---
    onAuthStateChanged(auth, (user) => {
      document.body.classList.toggle('authed', !!user);
      if(!user){ closeDrawer(); }
      if(unsubClients){ unsubClients(); unsubClients = null; }
      if(unsubFolders){ unsubFolders(); unsubFolders = null; }
      raw = [];
      foldersArr = [];
      clearList();
      showEmptyBox(false);
      clearSelection();

      if(!user){
        statusLine.textContent = "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ö–æ–¥–∞‚Ä¶";
        authBox.style.display = "block";
        filtersBox.style.display = "none";
        foldersPanel.style.display = "none";
        userPill.style.display = "none";
        btnSignOut.style.display = "none";
        return;
      }

      authBox.style.display = "none";
      filtersBox.style.display = "block";
      foldersPanel.style.display = "block";
      userPill.style.display = "block";
      btnSignOut.style.display = "inline-block";
      userPill.textContent = `–í–æ—à–ª–∏: ${user.email || user.uid}`;
      closeDrawer();
      setActiveNav('clients');

      // Apply saved UI state
      applyStateToInputs();
      setupAccordions();

      statusLine.textContent = "üü¢ –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ‚Ä¶";

      // folders realtime
      const fQ = query(collection(db, FOLDERS_COLLECTION), orderBy("name", "asc"));
      unsubFolders = onSnapshot(fQ, (snap) => {
        foldersArr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderFolders();
        applyFiltersAndRender(); // update folder labels
      }, (err) => {
        console.error(err);
      });

      // clients realtime
      const cQ = query(collection(db, CLIENTS_COLLECTION), orderBy("timestamp", "desc"));
      unsubClients = onSnapshot(cQ, (snap) => {
        raw = snap.docs.map(d => ({ id: d.id, data: d.data() }));
        statusLine.textContent = `üü¢ –ì–æ—Ç–æ–≤–æ ‚Ä¢ ${raw.length} –∑–∞–ø–∏—Å–µ–π`;
        renderFolders();
        applyFiltersAndRender();
      }, (err) => {
        statusLine.innerHTML = `<span class="dangerText">‚ùå ${escapeHtml(err?.message || err)}</span>`;
      });
    });
  </script>
</body>
</html>
